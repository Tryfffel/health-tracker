<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H√§lsodagbok</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div id="root"></div>
<div id="error-display" style="display:none;padding:20px;background:#fee2e2;color:#991b1b;font-family:monospace;font-size:13px;white-space:pre-wrap;margin:20px;border-radius:8px;"></div>
<script>
window.addEventListener('error', function(e) {
  var el = document.getElementById('error-display');
  el.style.display = 'block';
  el.textContent = 'FEL: ' + e.message + '\nRad: ' + e.lineno + '\nFil: ' + e.filename;
});
</script>
<script>
// localStorage polyfill matching the window.storage API
window.storage = {
  get: async (key) => ({ value: localStorage.getItem(key) }),
  set: async (key, value) => { localStorage.setItem(key, value); }
};

const h = React.createElement;
const { useState, useEffect } = React;

// ‚îÄ‚îÄ‚îÄ SVG Charts (no external library needed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function SvgLineChart({ data, lines, height }) {
  height = height || 260;
  if (!data || data.length < 2) return h('p', {className:'text-gray-400 text-sm text-center py-8'}, 'L√§gg till fler m√§tningar f√∂r att se grafen');
  var PL=50,PR=20,PT=20,PB=36,W=800,H=height;
  var chartW=W-PL-PR, chartH=H-PT-PB;
  var allVals=[];
  lines.forEach(function(l){ data.forEach(function(d){ if(d[l.key]!=null) allVals.push(d[l.key]); }); });
  var minV=Math.min.apply(null,allVals)-0.5, maxV=Math.max.apply(null,allVals)+0.5;
  var rng=maxV-minV||1;
  var tx=function(i){ return PL+(i/(data.length-1))*chartW; };
  var ty=function(v){ return PT+chartH-((v-minV)/rng)*chartH; };
  var gridEls=[];
  for(var gi=0;gi<=4;gi++){
    var gv=minV+(rng/4)*gi, gy=ty(gv);
    gridEls.push(h('line',{key:'g'+gi,x1:PL,y1:gy,x2:PL+chartW,y2:gy,stroke:'#f0f0f0',strokeWidth:1}));
    gridEls.push(h('text',{key:'gt'+gi,x:PL-4,y:gy+4,textAnchor:'end',fontSize:10,fill:'#9ca3af'},gv.toFixed(1)));
  }
  var nth=Math.max(1,Math.ceil(data.length/8));
  var xLabels=data.map(function(d,i){
    if(i%nth!==0&&i!==data.length-1) return null;
    return h('text',{key:'xl'+i,x:tx(i),y:PT+chartH+18,textAnchor:'middle',fontSize:9,fill:'#9ca3af'},d.datum);
  });
  var lineEls=lines.map(function(l){
    var pts=data.filter(function(d){return d[l.key]!=null;}).map(function(d,_,arr){
      var i=data.indexOf(d); return tx(i)+','+ty(d[l.key]);
    }).join(' ');
    return h('polyline',{key:l.key,points:pts,fill:'none',stroke:l.color,strokeWidth:l.width||1.5,strokeDasharray:l.dashed?'5,5':undefined});
  });
  var legendEls=lines.map(function(l,i){
    var lx=PL+i*140;
    return h('g',{key:'leg'+i},
      h('line',{x1:lx,y1:H-8,x2:lx+20,y2:H-8,stroke:l.color,strokeWidth:l.width||1.5,strokeDasharray:l.dashed?'5,5':undefined}),
      h('text',{x:lx+24,y:H-4,fontSize:10,fill:'#6b7280'},l.name)
    );
  });
  return h('svg',{viewBox:'0 0 '+W+' '+H,style:{width:'100%',height:height+'px'},xmlns:'http://www.w3.org/2000/svg'},
    h('line',{x1:PL,y1:PT,x2:PL,y2:PT+chartH,stroke:'#e5e7eb',strokeWidth:1}),
    h('line',{x1:PL,y1:PT+chartH,x2:PL+chartW,y2:PT+chartH,stroke:'#e5e7eb',strokeWidth:1}),
    ...gridEls, ...xLabels, ...lineEls, ...legendEls
  );
}

function SvgBarChart({ data, dataKey, color, height }) {
  height = height || 200;
  if (!data || data.length === 0) return null;
  var PL=50,PR=20,PT=20,PB=36,W=800,H=height;
  var chartW=W-PL-PR, chartH=H-PT-PB;
  var vals=data.map(function(d){return d[dataKey]||0;}), maxV=Math.max.apply(null,vals)||1;
  var bW=(chartW/data.length)*0.75;
  var bars=data.map(function(d,i){
    var v=d[dataKey]||0, bH=(v/maxV)*chartH;
    var bx=PL+(i/data.length)*chartW+(chartW/data.length)*0.125;
    return h('rect',{key:i,x:bx,y:PT+chartH-bH,width:bW,height:bH,fill:color,rx:2});
  });
  var nth=Math.max(1,Math.ceil(data.length/8));
  var xLabels=data.map(function(d,i){
    if(i%nth!==0&&i!==data.length-1) return null;
    var bx=PL+(i/data.length)*chartW+(chartW/data.length)*0.125+bW/2;
    return h('text',{key:'xl'+i,x:bx,y:PT+chartH+18,textAnchor:'middle',fontSize:9,fill:'#9ca3af'},d.datum);
  });
  var yLabels=[];
  for(var yi=0;yi<=4;yi++){
    var yv=Math.round((maxV/4)*yi), yyy=PT+chartH-(yi/4)*chartH;
    yLabels.push(h('text',{key:'y'+yi,x:PL-4,y:yyy+4,textAnchor:'end',fontSize:10,fill:'#9ca3af'},yv>=1000?Math.round(yv/1000)+'k':yv));
  }
  return h('svg',{viewBox:'0 0 '+W+' '+H,style:{width:'100%',height:height+'px'},xmlns:'http://www.w3.org/2000/svg'},
    h('line',{x1:PL,y1:PT+chartH,x2:PL+chartW,y2:PT+chartH,stroke:'#e5e7eb',strokeWidth:1}),
    ...[0,1,2,3,4].map(function(i){var gy=PT+chartH-(i/4)*chartH;return h('line',{key:'g'+i,x1:PL,y1:gy,x2:PL+chartW,y2:gy,stroke:'#f0f0f0',strokeWidth:1});}),
    ...yLabels, ...xLabels, ...bars
  );
}

// ‚îÄ‚îÄ‚îÄ Sub-components ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const Toast = ({ toast, onClose }) => {
  if (!toast) return null;
  return h('div', {
    className: 'fixed top-4 right-4 z-50 px-5 py-3 rounded-xl shadow-lg text-white flex items-center gap-3 ' + (toast.type === 'error' ? 'bg-red-500' : 'bg-green-500')
  },
    h('span', { className: 'text-sm font-medium' }, toast.msg),
    h('button', { onClick: onClose, className: 'hover:opacity-70 text-lg leading-none ml-2' }, '√ó')
  );
};

const StatCard = ({ emoji, label, value, sub, subColor }) =>
  h('div', { className: 'bg-white rounded-xl p-4 shadow-md' },
    h('div', { className: 'text-2xl mb-1' }, emoji),
    h('p', { className: 'text-xs text-gray-500 uppercase tracking-wide font-medium' }, label),
    h('p', { className: 'text-2xl font-bold text-gray-800 mt-1' }, value),
    sub ? h('p', { className: 'text-xs mt-1 ' + (subColor || 'text-gray-500') }, sub) : null
  );

const IntensityDots = ({ level }) =>
  h('span', { className: 'inline-flex gap-0.5 items-center' },
    ...[1,2,3,4,5].map(i =>
      h('span', { key: i, className: 'w-2 h-2 rounded-full ' + (i <= level ? 'bg-orange-400' : 'bg-gray-200') })
    )
  );

// ‚îÄ‚îÄ‚îÄ Main Component ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function WeightStepTracker() {
  const todayStr = () => new Date().toISOString().split('T')[0];

  const [entries, setEntries]       = useState([]);
  const [workouts, setWorkouts]     = useState([]);
  const [goalWeight, setGoalWeight] = useState(85);
  const [height, setHeight]         = useState(180);
  const [yearlyGoal, setYearlyGoal] = useState({ sessions: 100, minutes: 5000 });
  const [newEntry, setNewEntry]     = useState({ date: todayStr(), weight: '', steps: '', comment: '' });
  const [newWorkout, setNewWorkout] = useState({ date: todayStr(), type: '', duration: '', intensity: '3', comment: '' });
  const [view, setView]             = useState('overview');
  const [importText, setImportText] = useState('');
  const [showImport, setShowImport] = useState(false);
  const [toast, setToast]           = useState(null);
  const [loading, setLoading]       = useState(true);
  const [ouraToken, setOuraToken]       = useState('');
  const [ouraClientId, setOuraClientId] = useState('');
  const [ouraLoading, setOuraLoading]   = useState(false);

  const showToast = (msg, type) => {
    setToast({ msg, type: type || 'success' });
    setTimeout(() => setToast(null), 3000);
  };

  useEffect(() => { loadData(); }, []);
  useEffect(() => { if (!loading) saveData(); }, [entries, workouts, goalWeight, yearlyGoal, height, ouraToken, ouraClientId, loading]);

  const loadData = async () => {
    try {
      const results = await Promise.all([
        window.storage.get('weight-entries'),
        window.storage.get('workouts'),
        window.storage.get('goal-weight'),
        window.storage.get('yearly-goal'),
        window.storage.get('user-height'),
        window.storage.get('oura-token'),
        window.storage.get('oura-client-id'),
      ]);
      if (results[0] && results[0].value) setEntries(JSON.parse(results[0].value));
      if (results[1] && results[1].value) setWorkouts(JSON.parse(results[1].value));
      if (results[2] && results[2].value) setGoalWeight(parseFloat(results[2].value));
      if (results[3] && results[3].value) setYearlyGoal(JSON.parse(results[3].value));
      if (results[4] && results[4].value) setHeight(parseFloat(results[4].value));
      if (results[5] && results[5].value) setOuraToken(results[5].value);
      if (results[6] && results[6].value) setOuraClientId(results[6].value);
    } catch (err) {
      console.log('Ingen sparad data', err);
    } finally {
      setLoading(false);
    }
  };

  const saveData = async () => {
    try {
      await Promise.all([
        window.storage.set('weight-entries', JSON.stringify(entries)),
        window.storage.set('workouts',        JSON.stringify(workouts)),
        window.storage.set('goal-weight',     goalWeight.toString()),
        window.storage.set('yearly-goal',     JSON.stringify(yearlyGoal)),
        window.storage.set('user-height',     height.toString()),
        window.storage.set('oura-token',      ouraToken),
        window.storage.set('oura-client-id',  ouraClientId),
      ]);
    } catch (err) { console.error(err); }
  };

  // ‚îÄ‚îÄ Oura OAuth (implicit flow ‚Äì no server needed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const ouraRedirectUri = window.location.origin + window.location.pathname.replace(/\/$/, '') + '/';

  const startOuraOAuth = function() {
    if (!ouraClientId.trim()) { showToast('Ange ditt Oura Client ID i f√§ltet ovan', 'error'); return; }
    var params = new URLSearchParams({
      response_type: 'token',
      client_id: ouraClientId.trim(),
      redirect_uri: ouraRedirectUri,
      scope: 'daily personal',
      state: 'ht'
    });
    window.location.href = 'https://cloud.ouraring.com/oauth/authorize?' + params.toString();
  };

  useEffect(function() {
    // Handle implicit flow: token arrives in URL hash (#access_token=...)
    var hash = window.location.hash;
    if (hash && hash.includes('access_token')) {
      var hashParams = new URLSearchParams(hash.replace(/^#/, ''));
      var token = hashParams.get('access_token');
      if (token) {
        setOuraToken(token);
        window.history.replaceState({}, '', window.location.pathname);
        showToast('‚úÖ Oura ansluten!');
        setView('settings');
      }
    }
  }, []);
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  const fetchOura = async (dateStr) => {
    var token = ouraToken.trim();
    if (!token) { showToast('Ange din Oura-token i Inst√§llningar f√∂rst', 'error'); return; }
    setOuraLoading(true);
    try {
      const controller = new AbortController();
      const timer = setTimeout(function(){ controller.abort(); }, 10000);
      var endD = new Date(dateStr); endD.setDate(endD.getDate() + 1);
      var startD = new Date(dateStr); startD.setDate(startD.getDate() - 30);
      var startStr = startD.toISOString().split('T')[0];
      var endStr = endD.toISOString().split('T')[0];
      // Use access_token as query param to avoid Safari CORS preflight blocking Authorization header
      var actUrl = 'https://api.ouraring.com/v2/usercollection/daily_activity?start_date=' + startStr + '&end_date=' + endStr + '&access_token=' + encodeURIComponent(token);
      var actRes = await fetch(actUrl, { signal: controller.signal });
      clearTimeout(timer);
      if (!actRes.ok) throw new Error('HTTP ' + actRes.status);
      var actJson = await actRes.json();
      var day = actJson.data && (actJson.data.find(function(d){ return d.day && d.day.startsWith(dateStr); }) || actJson.data.find(function(d){ return d.timestamp && d.timestamp.startsWith(dateStr); }) || actJson.data[actJson.data.length - 1]);
      if (!day) {
        // Fallback: show what keys the first record has (debug)
        var firstRecord = actJson.data && actJson.data[0];
        showToast('Hittade ' + (actJson.data ? actJson.data.length : 0) + ' poster. ' + (firstRecord ? 'Nycklar: ' + Object.keys(firstRecord).join(', ') : 'Tom lista.'), 'error');
        return;
      }
      var foundDate = day.day || (day.timestamp ? day.timestamp.substring(0,10) : dateStr);
      var steps = day.steps || 0;
      setNewEntry(function(prev) {
        return Object.assign({}, prev, { steps: steps ? String(steps) : prev.steps, date: foundDate });
      });
      showToast('‚úÖ H√§mtade ' + steps.toLocaleString() + ' steg (' + foundDate + ') fr√•n Oura');
    } catch(err) {
      showToast('Kunde inte h√§mta fr√•n Oura: ' + err.message, 'error');
    } finally {
      setOuraLoading(false);
    }
  };

  const addEntry = () => {
    if (!newEntry.weight) return;
    const entry = {
      date: newEntry.date,
      weight: parseFloat(newEntry.weight),
      steps: newEntry.steps ? parseInt(newEntry.steps) : null,
      comment: newEntry.comment,
      id: Date.now(),
    };
    setEntries(function(prev) {
      return prev.filter(function(e) { return e.date !== entry.date; }).concat(entry)
        .sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
    });
    const next = new Date(newEntry.date);
    next.setDate(next.getDate() + 1);
    setNewEntry({ date: next.toISOString().split('T')[0], weight: '', steps: '', comment: '' });
    showToast('‚úì M√§tning sparad!');
  };

  const addWorkout = () => {
    if (!newWorkout.type || !newWorkout.duration) return;
    const workout = {
      date: newWorkout.date,
      type: newWorkout.type,
      duration: parseInt(newWorkout.duration),
      intensity: parseInt(newWorkout.intensity || 3),
      comment: newWorkout.comment,
      id: Date.now(),
    };
    setWorkouts(function(prev) {
      return prev.concat(workout).sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
    });
    const next = new Date(newWorkout.date);
    next.setDate(next.getDate() + 1);
    setNewWorkout({ date: next.toISOString().split('T')[0], type: '', duration: '', intensity: '3', comment: '' });
    showToast('üí™ Tr√§ningspass sparat!');
  };

  const deleteEntry   = function(id) { setEntries(function(prev) { return prev.filter(function(e) { return e.id !== id; }); }); };
  const deleteWorkout = function(id) { setWorkouts(function(prev) { return prev.filter(function(w) { return w.id !== id; }); }); };

  const exportData = () => {
    const data = { entries, workouts, goalWeight, height, yearlyGoal, exportDate: new Date().toISOString() };
    const blob  = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url   = URL.createObjectURL(blob);
    const link  = document.createElement('a');
    link.href   = url;
    link.download = 'halsodagbok_' + todayStr() + '.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    showToast('üíæ Backup nedladdad!');
  };

  const importFromFile = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        if (data.entries)    setEntries(data.entries);
        if (data.workouts)   setWorkouts(data.workouts);
        if (data.goalWeight) setGoalWeight(data.goalWeight);
        if (data.yearlyGoal) setYearlyGoal(data.yearlyGoal);
        if (data.height)     setHeight(data.height);
        showToast('‚úì Data importerad!');
        setShowImport(false);
        setView('overview');
      } catch(err) { showToast('Kunde inte l√§sa filen', 'error'); }
    };
    reader.readAsText(file);
  };

  const importHistoricalData = () => {
    const lines = importText.trim().split('\n');
    const imported = [];
    const months = { jan:'01',feb:'02',mar:'03',apr:'04',maj:'05',jun:'06',jul:'07',aug:'08',sep:'09',okt:'10',nov:'11',dec:'12' };
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i].trim();
      if (!line) continue;
      const parts = line.split(/[\t\s]+/).filter(function(p) { return p; });
      if (parts.length >= 2) {
        const match = parts[0].match(/(\d+)-(\w+)/);
        if (match) {
          const day   = match[1].length === 1 ? '0' + match[1] : match[1];
          const month = months[match[2].toLowerCase()];
          if (month) {
            const weight = parseFloat(parts[1].replace(',', '.'));
            if (!isNaN(weight)) {
              imported.push({ date: '2025-' + month + '-' + day, weight: weight, steps: null, comment: '', id: Date.now() + imported.length + Math.random() });
            }
          }
        }
      }
    }
    if (imported.length > 0) {
      const combined = entries.concat(imported);
      const map = {};
      combined.forEach(function(e) { map[e.date] = e; });
      const unique = Object.values(map).sort(function(a,b) { return new Date(a.date) - new Date(b.date); });
      setEntries(unique);
      setImportText(''); setShowImport(false); setView('overview');
      showToast('‚úì Importerade ' + imported.length + ' m√§tningar!');
    } else { showToast('Ingen giltig data hittades', 'error'); }
  };

  const getBMI = function(weight) {
    if (!height || !weight) return null;
    const hm = height / 100;
    return parseFloat((weight / (hm * hm)).toFixed(1));
  };

  const getBMICategory = function(bmi) {
    if (bmi < 18.5) return { label: 'Undervikt',  color: 'text-blue-600' };
    if (bmi < 25)   return { label: 'Normalvikt', color: 'text-green-600' };
    if (bmi < 30)   return { label: '√ñvervikt',   color: 'text-yellow-600' };
    return             { label: 'Fetma',       color: 'text-red-600' };
  };

  const getStreak = function() {
    if (entries.length === 0) return 0;
    const sorted = entries.slice().sort(function(a,b) { return new Date(b.date) - new Date(a.date); });
    const todayD  = new Date(); todayD.setHours(0,0,0,0);
    const latestD = new Date(sorted[0].date); latestD.setHours(0,0,0,0);
    if ((todayD - latestD) / 86400000 > 1) return 0;
    let streak = 1;
    let prev = new Date(sorted[0].date); prev.setHours(0,0,0,0);
    for (let i = 1; i < sorted.length; i++) {
      const d = new Date(sorted[i].date); d.setHours(0,0,0,0);
      if ((prev - d) / 86400000 === 1) { streak++; prev = d; } else break;
    }
    return streak;
  };

  const getCalories = function(type, duration, weight) {
    weight = weight || 80;
    const mets = { 'Styrketr√§ning':5,'L√∂pning':9,'Promenad':3.5,'Cykling':7,'Simning':7,'Yoga':2.5,'Pilates':3,'Fotboll':7,'Tennis':7,'Golf':4,'Skid√•kning':7,'Innebandy':8,'Dans':5,'Boxning':9,'Kl√§ttring':8,'Crossfit':10,'Spinning':8,'Grupptr√§ning':6,'Baseboll':4,'Annat':5 };
    return Math.round((mets[type] || 5) * weight * (duration / 60));
  };

  const getWeekNumber = function(date) {
    const d = new Date(date);
    const diff = d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1);
    const monday = new Date(d.setDate(diff));
    monday.setHours(0,0,0,0);
    return monday.toISOString().split('T')[0];
  };

  const getISOWeekNumber = function(date) {
    const d = new Date(date);
    d.setHours(0,0,0,0);
    d.setDate(d.getDate() + 4 - (d.getDay() || 7));
    const yearStart = new Date(d.getFullYear(), 0, 1);
    return 'V' + Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  };

  const getWeeklyStats = function() {
    if (entries.length === 0) return [];
    const sorted = entries.slice().sort(function(a,b) { return new Date(a.date) - new Date(b.date); });
    const weekMap = {};
    sorted.forEach(function(entry) {
      const ws = getWeekNumber(entry.date);
      if (!weekMap[ws]) weekMap[ws] = { weekStart: ws, weights: [], steps: [] };
      weekMap[ws].weights.push(entry.weight);
      if (entry.steps) weekMap[ws].steps.push(entry.steps);
    });
    const weeks = Object.values(weekMap).map(function(week) {
      const avgWeight = week.weights.reduce(function(a,b){return a+b;},0) / week.weights.length;
      const avgSteps  = week.steps.length ? Math.round(week.steps.reduce(function(a,b){return a+b;},0) / week.steps.length) : 0;
      const weekWorkouts = workouts.filter(function(w) { return getWeekNumber(w.date) === week.weekStart; });
      return {
        weekStart: week.weekStart, weekNumber: getISOWeekNumber(week.weekStart),
        avgWeight: parseFloat(avgWeight.toFixed(1)),
        avgSteps: avgSteps,
        workoutCount: weekWorkouts.length,
        totalMinutes: weekWorkouts.reduce(function(s,w){return s+w.duration;},0),
        change: 0,
      };
    });
    for (let i = 1; i < weeks.length; i++) {
      weeks[i].change = parseFloat((weeks[i].avgWeight - weeks[i-1].avgWeight).toFixed(2));
    }
    return weeks.sort(function(a,b) { return new Date(b.weekStart) - new Date(a.weekStart); });
  };

  const getCurrentWeekStats = function() {
    const ws = getWeeklyStats();
    if (!ws.length) return null;
    return { thisWeek: ws[0], lastWeek: ws[1] || null };
  };

  const getYearlyProgress = function() {
    const yr = new Date().getFullYear();
    const yearWorkouts = workouts.filter(function(w) { return new Date(w.date).getFullYear() === yr; });
    const totalSessions = yearWorkouts.length;
    const totalMinutes  = yearWorkouts.reduce(function(s,w){return s+w.duration;},0);
    const weeksElapsed  = Math.floor((new Date() - new Date(yr, 0, 1)) / (7*24*60*60*1000)) + 1;
    const expectedSessions = Math.round((yearlyGoal.sessions / 52) * weeksElapsed);
    const expectedMinutes  = Math.round((yearlyGoal.minutes  / 52) * weeksElapsed);
    return {
      totalSessions: totalSessions, totalMinutes: totalMinutes,
      goalSessions: yearlyGoal.sessions, goalMinutes: yearlyGoal.minutes,
      sessionsProgress: Math.min(totalSessions / yearlyGoal.sessions * 100, 100).toFixed(1),
      minutesProgress:  Math.min(totalMinutes  / yearlyGoal.minutes  * 100, 100).toFixed(1),
      onTrackSessions: totalSessions >= expectedSessions,
      onTrackMinutes:  totalMinutes  >= expectedMinutes,
      aheadSessions: totalSessions - expectedSessions,
      aheadMinutes:  totalMinutes  - expectedMinutes,
    };
  };

  const getStats = function() {
    if (entries.length === 0) return null;
    const sorted    = entries.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date);});
    const latest    = sorted[sorted.length - 1];
    const previous  = sorted[sorted.length - 2];
    const diff      = previous ? (latest.weight - previous.weight).toFixed(1) : 0;
    const toGoal    = (latest.weight - goalWeight).toFixed(1);
    const totalLoss = (sorted[0].weight - latest.weight).toFixed(1);
    const recentSteps = sorted.slice(-7).filter(function(e){return e.steps;}).map(function(e){return e.steps;});
    const avgSteps  = recentSteps.length ? Math.round(recentSteps.reduce(function(a,b){return a+b;},0) / recentSteps.length) : 0;
    const bmi    = getBMI(latest.weight);
    const bmiCat = bmi ? getBMICategory(bmi) : null;
    return { latest: latest, diff: diff, toGoal: toGoal, totalLoss: totalLoss, avgSteps: avgSteps, bmi: bmi, bmiCat: bmiCat, streak: getStreak() };
  };

  const getChartData = function() {
    const sorted = entries.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date);});
    return sorted.map(function(entry, idx) {
      const w7 = sorted.slice(Math.max(0, idx - 6), idx + 1);
      return {
        datum:   new Date(entry.date).toLocaleDateString('sv-SE', { month: 'short', day: 'numeric' }),
        vikt:    entry.weight,
        steg:    entry.steps || 0,
        m√•lvikt: goalWeight,
        snitt7:  parseFloat((w7.reduce(function(s,e){return s+e.weight;},0) / w7.length).toFixed(2)),
      };
    });
  };

  const stats        = getStats();
  const weeklyStats  = getWeeklyStats();
  const currentWeek  = getCurrentWeekStats();
  const yearProgress = getYearlyProgress();
  const chartData    = getChartData();

  const NavButton = function(props) {
    return h('button', {
      onClick: function() { setView(props.id); },
      className: 'px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors ' + (view === props.id ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-indigo-50')
    }, props.label);
  };

  if (loading) {
    return h('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center' },
      h('div', { className: 'text-center' },
        h('div', { className: 'text-5xl mb-4' }, 'üèÉ'),
        h('p', { className: 'text-gray-500' }, 'Laddar‚Ä¶')
      )
    );
  }

  // ‚îÄ‚îÄ‚îÄ View rendering helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function renderOverview() {
    if (!stats) {
      return h('div', { className: 'bg-white rounded-xl p-12 text-center shadow-md' },
        h('div', { className: 'text-5xl mb-4' }, 'üìä'),
        h('p', { className: 'text-gray-600 text-lg mb-2' }, 'Ingen data √§n'),
        h('p', { className: 'text-gray-400 text-sm mb-6' }, 'L√§gg till din f√∂rsta vikt eller importera historik'),
        h('div', { className: 'flex gap-3 justify-center flex-wrap' },
          h('button', { onClick: function(){setView('add');}, className: 'bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700' }, 'L√§gg till m√§tning'),
          h('button', { onClick: function(){setShowImport(true);}, className: 'bg-white border-2 border-indigo-200 text-indigo-600 px-6 py-3 rounded-lg hover:bg-indigo-50' }, 'Importera data')
        )
      );
    }

    const diffNum = parseFloat(stats.diff);
    return h('div', null,
      // Row 1 stats
      h('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-4' },
        h(StatCard, { emoji:'üìâ', label:'Senaste vikt', value: stats.latest.weight + ' kg', sub: (diffNum > 0 ? '+' : '') + stats.diff + ' kg fr√•n f√∂rra', subColor: diffNum <= 0 ? 'text-green-600' : 'text-red-500' }),
        h(StatCard, { emoji:'üéØ', label:'Till m√•let', value: Math.abs(stats.toGoal) + ' kg', sub: 'M√•l: ' + goalWeight + ' kg' }),
        h(StatCard, { emoji:'üî•', label:'Total nedg√•ng', value: stats.totalLoss + ' kg', sub: entries.length + ' m√§tningar' }),
        stats.bmi
          ? h(StatCard, { emoji:'‚öñÔ∏è', label:'BMI', value: stats.bmi, sub: stats.bmiCat ? stats.bmiCat.label : '', subColor: stats.bmiCat ? stats.bmiCat.color : '' })
          : h(StatCard, { emoji:'üëü', label:'Snitt steg (7d)', value: stats.avgSteps.toLocaleString(), sub: 'senaste 7 dagarna' })
      ),
      // Row 2 stats
      h('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-6' },
        h(StatCard, { emoji:'üèÜ', label:'Inloggningssvit', value: stats.streak + ' üî•', sub: stats.streak > 0 ? 'dagar i rad' : 'Logga idag!' }),
        h(StatCard, { emoji:'üëü', label:'Snitt steg (7d)', value: stats.avgSteps.toLocaleString(), sub: 'senaste veckan' }),
        h('div', { className: 'bg-white rounded-xl p-4 shadow-md col-span-2' },
          h('p', { className: 'text-xs text-gray-500 uppercase tracking-wide font-medium mb-2' }, 'üí™ Veckotr√§ning'),
          currentWeek
            ? h('div', { className: 'flex gap-8' },
                h('div', null,
                  h('p', { className: 'text-xl font-bold text-gray-800' }, currentWeek.thisWeek.workoutCount + ' pass'),
                  h('p', { className: 'text-xs text-gray-500' }, currentWeek.thisWeek.totalMinutes + ' min ¬∑ denna vecka')
                ),
                currentWeek.lastWeek ? h('div', { className: 'text-gray-400' },
                  h('p', { className: 'text-xl font-bold' }, currentWeek.lastWeek.workoutCount + ' pass'),
                  h('p', { className: 'text-xs' }, currentWeek.lastWeek.totalMinutes + ' min ¬∑ f√∂rra veckan')
                ) : null
              )
            : h('p', { className: 'text-gray-400 text-sm' }, 'Ingen tr√§ning loggad')
        )
      ),
      // This/last week
      currentWeek ? h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-6' },
        h('div', { className: 'bg-gradient-to-r from-indigo-50 to-blue-50 border-2 border-indigo-200 rounded-xl p-5' },
          h('h3', { className: 'text-xs font-bold text-indigo-600 mb-3 uppercase tracking-wide' }, 'üìÖ Denna vecka (' + currentWeek.thisWeek.weekNumber + ')'),
          h('div', { className: 'grid grid-cols-2 gap-3' },
            h('div', null, h('p', {className:'text-xs text-gray-500'}, 'Snitt vikt'), h('p', {className:'text-xl font-bold text-indigo-700'}, currentWeek.thisWeek.avgWeight + ' kg')),
            h('div', null, h('p', {className:'text-xs text-gray-500'}, 'F√∂r√§ndring'), h('p', {className:'text-xl font-bold ' + (currentWeek.thisWeek.change <= 0 ? 'text-green-600' : 'text-red-500')}, (currentWeek.thisWeek.change > 0 ? '+' : '') + currentWeek.thisWeek.change + ' kg')),
            h('div', null, h('p', {className:'text-xs text-gray-500'}, 'Snitt steg'), h('p', {className:'text-xl font-bold text-indigo-700'}, currentWeek.thisWeek.avgSteps.toLocaleString())),
            h('div', null, h('p', {className:'text-xs text-gray-500'}, 'Tr√§ning'), h('p', {className:'text-xl font-bold text-indigo-700'}, currentWeek.thisWeek.workoutCount + ' pass'), h('p', {className:'text-xs text-gray-400'}, currentWeek.thisWeek.totalMinutes + ' min'))
          )
        ),
        currentWeek.lastWeek ? h('div', { className: 'bg-white border-2 border-gray-100 rounded-xl p-5' },
          h('h3', { className: 'text-xs font-bold text-gray-400 mb-3 uppercase tracking-wide' }, 'üìä F√∂rra veckan (' + currentWeek.lastWeek.weekNumber + ')'),
          h('div', { className: 'grid grid-cols-2 gap-3' },
            h('div', null, h('p', {className:'text-xs text-gray-500'}, 'Snitt vikt'), h('p', {className:'text-xl font-bold text-gray-700'}, currentWeek.lastWeek.avgWeight + ' kg')),
            h('div', null, h('p', {className:'text-xs text-gray-500'}, 'F√∂r√§ndring'), h('p', {className:'text-xl font-bold ' + (currentWeek.lastWeek.change <= 0 ? 'text-green-600' : 'text-red-500')}, (currentWeek.lastWeek.change > 0 ? '+' : '') + currentWeek.lastWeek.change + ' kg')),
            h('div', null, h('p', {className:'text-xs text-gray-500'}, 'Snitt steg'), h('p', {className:'text-xl font-bold text-gray-700'}, currentWeek.lastWeek.avgSteps.toLocaleString())),
            h('div', null, h('p', {className:'text-xs text-gray-500'}, 'Tr√§ning'), h('p', {className:'text-xl font-bold text-gray-700'}, currentWeek.lastWeek.workoutCount + ' pass'), h('p', {className:'text-xs text-gray-400'}, currentWeek.lastWeek.totalMinutes + ' min'))
          )
        ) : null
      ) : null,
      // Weight chart
      h('div', { className: 'bg-white rounded-xl p-6 shadow-md mb-6' },
        h('h2', { className: 'text-lg font-bold text-gray-800 mb-1' }, 'Viktutveckling'),
        h('p', { className: 'text-xs text-gray-400 mb-4' }, 'Daglig vikt + 7-dagars glidande medelv√§rde'),
        h(SvgLineChart, { data: chartData, height: 300, lines: [
          { key: 'vikt',    color: '#a5b4fc', width: 1.5, name: 'Vikt (kg)' },
          { key: 'snitt7',  color: '#4f46e5', width: 2.5, name: '7-dagars snitt' },
          { key: 'm√•lvikt', color: '#10b981', width: 1.5, name: 'M√•lvikt', dashed: true }
        ]})
      ),
      // Steps chart
      h('div', { className: 'bg-white rounded-xl p-6 shadow-md' },
        h('h2', { className: 'text-lg font-bold text-gray-800 mb-4' }, 'Steg per dag'),
        h(SvgBarChart, { data: chartData, dataKey: 'steg', color: '#fb923c', height: 200 })
      )
    );
  }

  function renderAdd() {
    const bmiPreview = newEntry.weight && height > 0 ? getBMI(parseFloat(newEntry.weight)) : null;
    return h('div', { className: 'max-w-lg mx-auto' },
      h('div', { className: 'bg-white rounded-xl p-6 shadow-md' },
        h('h2', { className: 'text-xl font-bold mb-5 text-gray-800' }, 'L√§gg till m√§tning'),
        h('div', { className: 'space-y-4' },
          h('div', { className: 'flex gap-2' },
            h('input', { type:'date', value: newEntry.date, onChange: function(e){setNewEntry(Object.assign({},newEntry,{date:e.target.value}));}, className:'flex-1 px-4 py-3 border rounded-lg outline-none' }),
            h('button', { onClick: function(){setNewEntry(Object.assign({},newEntry,{date:todayStr()}));}, className:'px-4 py-3 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100' }, 'Idag')
          ),
          h('div', { className: 'relative' },
            h('input', { type:'number', step:'0.1', value: newEntry.weight, onChange: function(e){setNewEntry(Object.assign({},newEntry,{weight:e.target.value}));}, placeholder:'Vikt (kg)', className:'w-full px-4 py-3 border rounded-lg outline-none' }),
            bmiPreview ? h('span', { className: 'absolute right-3 top-3.5 text-xs text-gray-400' }, 'BMI: ' + bmiPreview) : null
          ),
          h('div', { className: 'flex gap-2' },
            h('input', { type:'number', value: newEntry.steps, onChange: function(e){setNewEntry(Object.assign({},newEntry,{steps:e.target.value}));}, placeholder:'Steg (valfritt)', className:'flex-1 px-4 py-3 border rounded-lg outline-none' }),
            ouraToken ? h('button', {
              onClick: function(){ fetchOura(newEntry.date); },
              disabled: ouraLoading,
              title: 'H√§mta steg fr√•n Oura Ring',
              className: 'px-3 py-3 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100 disabled:opacity-50 whitespace-nowrap'
            }, ouraLoading ? '‚è≥' : 'üíç Oura') : null
          ),
          h('input', { type:'text', value: newEntry.comment, onChange: function(e){setNewEntry(Object.assign({},newEntry,{comment:e.target.value}));}, placeholder:'Kommentar (valfritt)', className:'w-full px-4 py-3 border rounded-lg outline-none' }),
          h('button', { onClick: addEntry, disabled: !newEntry.weight, className:'w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 disabled:opacity-40 font-medium' }, '+ Spara m√§tning')
        )
      )
    );
  }

  function renderWorkouts() {
    const workoutTypes = ['Styrketr√§ning','L√∂pning','Promenad','Cykling','Simning','Yoga','Pilates','Fotboll','Tennis','Baseboll','Golf','Skid√•kning','Innebandy','Dans','Boxning','Kl√§ttring','Crossfit','Spinning','Grupptr√§ning','Annat'];
    const currentWeight = stats ? stats.latest.weight : 80;
    const calPreview = newWorkout.type && newWorkout.duration ? getCalories(newWorkout.type, parseInt(newWorkout.duration), currentWeight) : null;

    return h('div', null,
      // Yearly goal
      h('div', { className: 'bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl p-6 mb-6' },
        h('div', { className: 'flex items-center justify-between mb-4' },
          h('h2', { className: 'text-lg font-bold text-gray-800' }, 'üéØ √Örsm√•l ' + new Date().getFullYear()),
          h('button', { onClick: function(){setView('goals');}, className:'text-xs text-orange-600 font-medium hover:underline' }, '√Ñndra m√•l ‚Üí')
        ),
        h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
          h('div', null,
            h('div', { className: 'flex justify-between mb-1' }, h('span', {className:'text-sm font-medium'}, 'Tr√§ningspass'), h('span', {className:'text-sm font-bold ' + (yearProgress.onTrackSessions ? 'text-green-600' : 'text-orange-600')}, yearProgress.totalSessions + '/' + yearProgress.goalSessions)),
            h('div', { className: 'w-full bg-gray-200 rounded-full h-3 mb-1' }, h('div', { className: 'h-3 rounded-full ' + (yearProgress.onTrackSessions ? 'bg-green-500' : 'bg-orange-500'), style: { width: yearProgress.sessionsProgress + '%' } })),
            h('p', { className: 'text-xs ' + (yearProgress.onTrackSessions ? 'text-green-600' : 'text-orange-500') }, yearProgress.onTrackSessions ? '‚úì F√∂re plan med ' + yearProgress.aheadSessions + ' pass' : Math.abs(yearProgress.aheadSessions) + ' pass efter plan')
          ),
          h('div', null,
            h('div', { className: 'flex justify-between mb-1' }, h('span', {className:'text-sm font-medium'}, 'Tr√§ningstid'), h('span', {className:'text-sm font-bold ' + (yearProgress.onTrackMinutes ? 'text-green-600' : 'text-orange-600')}, Math.round(yearProgress.totalMinutes/60) + 'h/' + Math.round(yearProgress.goalMinutes/60) + 'h')),
            h('div', { className: 'w-full bg-gray-200 rounded-full h-3 mb-1' }, h('div', { className: 'h-3 rounded-full ' + (yearProgress.onTrackMinutes ? 'bg-green-500' : 'bg-orange-500'), style: { width: yearProgress.minutesProgress + '%' } })),
            h('p', { className: 'text-xs ' + (yearProgress.onTrackMinutes ? 'text-green-600' : 'text-orange-500') }, yearProgress.onTrackMinutes ? '‚úì F√∂re plan med ' + Math.abs(yearProgress.aheadMinutes) + ' min' : Math.abs(yearProgress.aheadMinutes) + ' min efter plan')
          )
        )
      ),
      // Add workout form
      h('div', { className: 'bg-white rounded-xl p-6 shadow-md mb-6' },
        h('h2', { className: 'text-lg font-bold mb-4 text-gray-800' }, 'L√§gg till tr√§ningspass'),
        h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
          h('div', { className: 'flex gap-2' },
            h('input', { type:'date', value:newWorkout.date, onChange:function(e){setNewWorkout(Object.assign({},newWorkout,{date:e.target.value}));}, className:'flex-1 px-4 py-3 border rounded-lg outline-none' }),
            h('button', { onClick:function(){setNewWorkout(Object.assign({},newWorkout,{date:todayStr()}));}, className:'px-3 py-3 bg-orange-50 text-orange-600 rounded-lg text-sm hover:bg-orange-100' }, 'Idag')
          ),
          h('select', { value:newWorkout.type, onChange:function(e){setNewWorkout(Object.assign({},newWorkout,{type:e.target.value}));}, className:'w-full px-4 py-3 border rounded-lg outline-none' },
            h('option', { value:'' }, 'V√§lj typ‚Ä¶'),
            ...workoutTypes.map(function(t) { return h('option', {key:t, value:t}, t); })
          ),
          h('div', null,
            h('input', { type:'number', value:newWorkout.duration, onChange:function(e){setNewWorkout(Object.assign({},newWorkout,{duration:e.target.value}));}, placeholder:'Minuter', className:'w-full px-4 py-3 border rounded-lg outline-none' }),
            calPreview ? h('p', { className:'text-xs text-gray-400 mt-1' }, '‚âà ' + calPreview + ' kcal') : null
          ),
          h('div', null,
            h('label', { className: 'text-xs text-gray-500 block mb-1' }, 'Intensitet (1‚Äì5)'),
            h('div', { className: 'flex gap-2' },
              ...[1,2,3,4,5].map(function(i) {
                return h('button', { key:i, onClick:function(){setNewWorkout(Object.assign({},newWorkout,{intensity:i.toString()}));}, className:'flex-1 py-2.5 rounded-lg text-sm font-bold ' + (parseInt(newWorkout.intensity) === i ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-orange-100') }, i);
              })
            )
          ),
          h('div', { className: 'md:col-span-2' },
            h('input', { type:'text', value:newWorkout.comment, onChange:function(e){setNewWorkout(Object.assign({},newWorkout,{comment:e.target.value}));}, placeholder:'Kommentar (valfritt)', className:'w-full px-4 py-3 border rounded-lg outline-none' })
          )
        ),
        h('button', { onClick:addWorkout, disabled:!newWorkout.type||!newWorkout.duration, className:'mt-4 w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 disabled:opacity-40 font-medium' }, 'üí™ Spara tr√§ningspass')
      ),
      // Workout history
      workouts.length > 0 ? h('div', { className: 'bg-white rounded-xl p-6 shadow-md' },
        h('div', { className: 'flex items-center justify-between mb-4' },
          h('h2', { className: 'text-lg font-bold text-gray-800' }, 'Senaste tr√§ningspass'),
          h('span', { className: 'text-xs text-gray-400' }, workouts.length + ' totalt')
        ),
        h('div', { className: 'space-y-2 max-h-96 overflow-y-auto' },
          ...workouts.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date);}).slice(0,25).map(function(w) {
            return h('div', { key:w.id, className:'flex items-center justify-between py-3 px-4 bg-gray-50 rounded-lg hover:bg-orange-50' },
              h('div', null,
                h('div', { className:'flex items-center gap-2 mb-0.5' },
                  h('span', { className:'font-medium text-sm text-gray-800' }, w.type),
                  w.intensity ? h(IntensityDots, { level:w.intensity }) : null
                ),
                h('p', { className:'text-xs text-gray-400' }, new Date(w.date).toLocaleDateString('sv-SE', { weekday:'short', day:'numeric', month:'short' }) + (w.comment ? ' ¬∑ ' + w.comment : ''))
              ),
              h('div', { className:'flex items-center gap-4' },
                h('div', { className:'text-right' },
                  h('p', { className:'text-sm font-bold text-gray-800' }, w.duration + ' min'),
                  h('p', { className:'text-xs text-gray-400' }, '‚âà ' + getCalories(w.type, w.duration, currentWeight) + ' kcal')
                ),
                h('button', { onClick:function(){deleteWorkout(w.id);}, className:'text-gray-300 hover:text-red-500' }, '‚úï')
              )
            );
          })
        )
      ) : null
    );
  }

  function renderGoals() {
    return h('div', { className: 'max-w-lg mx-auto' },
      h('div', { className: 'bg-white rounded-xl p-6 shadow-md' },
        h('h2', { className: 'text-xl font-bold mb-5 text-gray-800' }, 'M√•l & inst√§llningar'),
        h('div', { className: 'space-y-5' },
          h('div', null,
            h('label', { className: 'text-sm font-medium text-gray-700 block mb-1' }, 'M√•lvikt (kg)'),
            h('input', { type:'number', step:'0.5', value:goalWeight, onChange:function(e){setGoalWeight(parseFloat(e.target.value)||0);}, className:'w-full px-4 py-3 border rounded-lg outline-none' })
          ),
          h('div', null,
            h('label', { className: 'text-sm font-medium text-gray-700 block mb-1' }, 'Din l√§ngd (cm) ‚Äì f√∂r BMI'),
            h('input', { type:'number', value:height, onChange:function(e){setHeight(parseFloat(e.target.value)||0);}, className:'w-full px-4 py-3 border rounded-lg outline-none' })
          ),
          h('div', { className: 'border-t pt-5' },
            h('p', { className: 'text-sm font-semibold text-gray-700 mb-3' }, '√Örsm√•l ' + new Date().getFullYear()),
            h('div', { className: 'grid grid-cols-2 gap-3' },
              h('div', null,
                h('label', { className: 'text-xs text-gray-500' }, 'Tr√§ningspass'),
                h('input', { type:'number', value:yearlyGoal.sessions, onChange:function(e){setYearlyGoal(Object.assign({},yearlyGoal,{sessions:parseInt(e.target.value)||0}));}, className:'w-full px-4 py-3 border rounded-lg outline-none mt-1' })
              ),
              h('div', null,
                h('label', { className: 'text-xs text-gray-500' }, 'Total tid (minuter)'),
                h('input', { type:'number', value:yearlyGoal.minutes, onChange:function(e){setYearlyGoal(Object.assign({},yearlyGoal,{minutes:parseInt(e.target.value)||0}));}, className:'w-full px-4 py-3 border rounded-lg outline-none mt-1' })
              )
            )
          ),
          h('button', { onClick:function(){setView('workouts');}, className:'w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-medium' }, '‚úì Spara')
        )
      )
    );
  }

  function renderHistory() {
    const sortedEntries = entries.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date);});
    return h('div', { className: 'bg-white rounded-xl p-6 shadow-md' },
      h('div', { className: 'flex items-center justify-between mb-4' },
        h('h2', { className: 'text-xl font-bold text-gray-800' }, 'M√§tningshistorik'),
        h('span', { className: 'text-sm text-gray-400' }, entries.length + ' m√§tningar')
      ),
      h('div', { className: 'overflow-x-auto' },
        h('table', { className: 'w-full' },
          h('thead', null,
            h('tr', { className: 'border-b-2 border-gray-100' },
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Datum'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Vikt'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Œî'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Steg'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Kommentar'),
              h('th', null)
            )
          ),
          h('tbody', null,
            ...sortedEntries.map(function(entry, idx) {
              const prev = sortedEntries[idx + 1];
              const diff = prev ? (entry.weight - prev.weight).toFixed(1) : null;
              const diffNum = diff !== null ? parseFloat(diff) : 0;
              return h('tr', { key: entry.id, className: 'border-b border-gray-50 hover:bg-gray-50' },
                h('td', { className: 'py-3 text-sm text-gray-700' }, new Date(entry.date).toLocaleDateString('sv-SE', { weekday:'short', day:'numeric', month:'short' })),
                h('td', { className: 'py-3 font-bold text-gray-800' }, entry.weight + ' kg'),
                h('td', { className: 'py-3 text-sm' }, diff !== null ? h('span', { className: diffNum <= 0 ? 'text-green-600' : 'text-red-500' }, (diffNum > 0 ? '+' : '') + diff) : null),
                h('td', { className: 'py-3 text-sm text-gray-500' }, entry.steps ? entry.steps.toLocaleString() : '‚Äì'),
                h('td', { className: 'py-3 text-xs text-gray-400 max-w-xs truncate' }, entry.comment || ''),
                h('td', { className: 'py-3' }, h('button', { onClick: function(){deleteEntry(entry.id);}, className:'text-gray-300 hover:text-red-500 text-xs' }, '‚úï'))
              );
            })
          )
        )
      )
    );
  }

  function renderWeekly() {
    return h('div', { className: 'bg-white rounded-xl p-6 shadow-md' },
      h('h2', { className: 'text-xl font-bold mb-4 text-gray-800' }, 'Vecko√∂versikt'),
      h('div', { className: 'overflow-x-auto' },
        h('table', { className: 'w-full' },
          h('thead', null,
            h('tr', { className: 'border-b-2 border-gray-100' },
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Vecka'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Snitt vikt'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'F√∂r√§ndring'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Steg/dag'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Pass'),
              h('th', { className: 'text-left py-3 text-xs uppercase tracking-wide text-gray-400' }, 'Min')
            )
          ),
          h('tbody', null,
            ...weeklyStats.map(function(week, idx) {
              return h('tr', { key: week.weekStart, className: 'border-b border-gray-50 hover:bg-gray-50 ' + (idx === 0 ? 'bg-indigo-50' : '') },
                h('td', { className: 'py-3 font-bold text-sm text-gray-800' }, week.weekNumber),
                h('td', { className: 'py-3 font-semibold text-gray-800' }, week.avgWeight + ' kg'),
                h('td', { className: 'py-3 font-medium text-sm ' + (week.change < 0 ? 'text-green-600' : week.change > 0 ? 'text-red-500' : 'text-gray-400') }, (week.change > 0 ? '+' : '') + week.change + ' kg'),
                h('td', { className: 'py-3 text-sm text-gray-600' }, week.avgSteps.toLocaleString()),
                h('td', { className: 'py-3 text-sm text-gray-600' }, week.workoutCount),
                h('td', { className: 'py-3 text-sm text-gray-500' }, week.totalMinutes || '‚Äì')
              );
            })
          )
        )
      )
    );
  }

  function renderSettings() {
    return h('div', { className: 'max-w-lg mx-auto space-y-6' },

      // Oura card
      h('div', { className: 'bg-white rounded-xl p-6 shadow-md' },
        h('div', { className: 'flex items-center gap-3 mb-4' },
          h('span', { className: 'text-3xl' }, 'üíç'),
          h('div', null,
            h('h2', { className: 'text-lg font-bold text-gray-800' }, 'Oura Ring'),
            h('p', { className: 'text-xs text-gray-400' }, 'H√§mta steg automatiskt n√§r du loggar')
          )
        ),

        ouraToken
          ? h('div', { className: 'space-y-3' },
              h('div', { className: 'flex items-center gap-2 text-sm text-green-600 bg-green-50 rounded-lg px-3 py-2' },
                h('span', null, '‚úÖ Oura √§r ansluten ‚Äî "üíç Oura"-knappen syns i L√§gg till-vyn')
              ),
              h('button', {
                onClick: function(){ setOuraToken(''); showToast('Oura fr√•nkopplad'); },
                className: 'text-xs text-red-500 hover:underline'
              }, 'Koppla fr√•n')
            )
          : h('div', { className: 'space-y-4' },
              h('div', { className: 'bg-blue-50 rounded-lg p-4 text-sm text-blue-800 space-y-2' },
                h('p', { className: 'font-semibold' }, 'Steg 1 ‚Äî Skapa en app p√• Oura:'),
                h('ol', { className: 'list-decimal list-inside space-y-1 text-xs' },
                  h('li', null, h('a', { href: 'https://cloud.ouraring.com/oauth/applications', target: '_blank', className: 'underline font-medium' }, '√ñppna cloud.ouraring.com/oauth/applications')),
                  h('li', null, 'Klicka "Create New Application"'),
                  h('li', null, 'Fyll i valfritt namn, t.ex. "H√§lsoapp"'),
                  h('li', null, 'S√§tt Redirect URI till:'),
                  h('div', { className: 'bg-white rounded px-2 py-1 font-mono text-xs mt-1 break-all select-all border' }, ouraRedirectUri),
                  h('li', { className: 'mt-1' }, 'Kopiera ditt Client ID')
                )
              ),
              h('div', null,
                h('label', { className: 'text-sm font-medium text-gray-700 block mb-1' }, 'Steg 2 ‚Äî Klistra in Client ID:'),
                h('input', {
                  type: 'text',
                  value: ouraClientId,
                  onChange: function(e){ setOuraClientId(e.target.value); },
                  placeholder: 'Ditt Oura Client ID...',
                  className: 'w-full px-4 py-3 border rounded-lg outline-none font-mono text-sm'
                })
              ),
              h('button', {
                onClick: startOuraOAuth,
                disabled: !ouraClientId.trim(),
                className: 'w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 disabled:opacity-40 font-medium'
              }, 'üîó Anslut med Oura')
            )
      ),

      // Apple Watch info card
      h('div', { className: 'bg-white rounded-xl p-6 shadow-md' },
        h('div', { className: 'flex items-center gap-3 mb-4' },
          h('span', { className: 'text-3xl' }, '‚åö'),
          h('div', null,
            h('h2', { className: 'text-lg font-bold text-gray-800' }, 'Apple Watch'),
            h('p', { className: 'text-xs text-gray-400' }, 'Via appen Health Auto Export')
          )
        ),
        h('p', { className: 'text-sm text-gray-600 mb-3' }, 'Apple Health har inget √∂ppet webb-API, men du kan exportera steg manuellt:'),
        h('ol', { className: 'text-sm text-gray-600 space-y-1 list-decimal list-inside' },
          h('li', null, '√ñppna H√§lsa-appen p√• iPhone'),
          h('li', null, 'Tryck p√• din profilbild ‚Üí Exportera alla h√§lsodata'),
          h('li', null, 'Eller skriv in stegen manuellt i "L√§gg till"-vyn')
        )
      )
    );
  }

  // ‚îÄ‚îÄ‚îÄ Main render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  return h('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4' },
    h(Toast, { toast: toast, onClose: function(){ setToast(null); } }),
    h('div', { className: 'max-w-6xl mx-auto' },

      // Header
      h('div', { className: 'bg-white rounded-2xl shadow-xl p-6 mb-6 flex items-center justify-between' },
        h('div', null,
          h('h1', { className: 'text-3xl font-bold text-gray-800 mb-1' }, 'üè• H√§lsodagbok'),
          h('p', { className: 'text-gray-500 text-sm' }, 'F√∂lj din vikt och aktivitet')
        ),
        stats ? h('div', { className: 'text-right' },
          h('p', { className: 'text-xs text-gray-400 uppercase tracking-wide' }, 'Senast loggat'),
          h('p', { className: 'font-bold text-gray-700' }, new Date(stats.latest.date).toLocaleDateString('sv-SE', { day:'numeric', month:'short' }))
        ) : null
      ),

      // Nav
      h('div', { className: 'flex gap-2 mb-6 overflow-x-auto pb-1' },
        h(NavButton, { id:'overview',  label:'√ñversikt' }),
        h(NavButton, { id:'add',       label:'+ L√§gg till' }),
        h(NavButton, { id:'workouts',  label:'Tr√§ning' }),
        h(NavButton, { id:'history',   label:'Historik' }),
        h(NavButton, { id:'weekly',    label:'Veckor' }),
        h(NavButton, { id:'settings',  label:'‚öôÔ∏è Inst√§llningar' }),
        h('button', { onClick:function(){setShowImport(!showImport);}, className:'px-4 py-2 rounded-lg font-medium whitespace-nowrap bg-white text-gray-700 border border-indigo-200 hover:bg-indigo-50' }, 'Backup')
      ),

      // Backup panel
      showImport ? h('div', { className: 'bg-white rounded-xl p-6 shadow-md mb-6' },
        h('div', { className: 'flex items-center justify-between mb-5' },
          h('h2', { className: 'text-xl font-bold text-gray-800' }, 'Backup & Import'),
          h('button', { onClick:function(){setShowImport(false);}, className:'text-gray-400 hover:text-gray-600 text-2xl leading-none' }, '√ó')
        ),
        h('div', { className: 'space-y-6' },
          h('div', { className: 'flex gap-3 flex-wrap' },
            h('button', { onClick:exportData, className:'bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 text-sm font-medium' }, 'üíæ Ladda ner backup'),
            h('label', { className:'bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium cursor-pointer' },
              'üìÇ √Öterst√§ll fr√•n fil',
              h('input', { type:'file', accept:'.json', onChange:importFromFile, className:'hidden' })
            )
          ),
          h('div', { className: 'border-t pt-5' },
            h('h3', { className: 'font-medium mb-1 text-sm text-gray-700' }, 'üìã Importera historisk viktdata'),
            h('p', { className: 'text-xs text-gray-400 mb-3' }, 'Format per rad: 03-nov 91,1'),
            h('textarea', { value:importText, onChange:function(e){setImportText(e.target.value);}, placeholder:'03-nov 91,1\n04-nov 90,8\n...', className:'w-full px-4 py-2 border rounded-lg font-mono text-sm mb-3 outline-none', rows:6 }),
            h('button', { onClick:importHistoricalData, className:'bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 text-sm font-medium' }, 'Importera')
          )
        )
      ) : null,

      // Views
      view === 'overview'  ? renderOverview()  : null,
      view === 'add'       ? renderAdd()       : null,
      view === 'workouts'  ? renderWorkouts()  : null,
      view === 'goals'     ? renderGoals()     : null,
      view === 'history'   ? renderHistory()   : null,
      view === 'weekly'    ? renderWeekly()    : null,
      view === 'settings'  ? renderSettings()  : null
    )
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(h(WeightStepTracker, null));
</script>
</body>
</html>
